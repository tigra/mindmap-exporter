# SVG Markdown Rendering Integration

This document explains how Markdown rendering to SVG is integrated in the mindmap renderer, including the two available methods for embedding SVG content.

## Overview

The mindmap renderer uses the `markdownToSvg` utility function to convert Markdown content to SVG. When integrating these SVGs into the larger mindmap SVG structure, there are two approaches available:

1. **Extract Method** (default): Extracts the inner content and applies coordinate transformations
2. **Embed Method**: Embeds the entire SVG element with positioning attributes

## Configuration

The SVG integration method can be configured by changing the `SVG_EMBEDDING_METHOD` static property in the `MindmapRenderer` class:

```javascript
// In src/renderer/mindmap-renderer.js
static SVG_EMBEDDING_METHOD = 'extract'; // Options: 'extract' or 'embed'
```

## Extract Method (Default)

The extraction method extracts the inner content from the SVG and applies coordinate transformations to account for dom-to-svg's coordinate system. This approach:

- Avoids nested SVG elements in the final output
- Properly handles dom-to-svg's negative coordinate system through transformations
- Works well for flatter SVG structures

Implementation:
```javascript
// Get SVG from markdownToSvg()
const markdownResult = await markdownToSvg(nodeText, maxWidth);

// Calculate position
const svgX = node.x + (node.width - markdownResult.dimensions.width) / 2;
const svgY = node.y + (node.height - markdownResult.dimensions.height) / 2;

// Extract content with utility function
const extractedContent = extractSvgContent(markdownResult.svg, svgX, svgY);
```

## Embedding Method (Alternative)

The embedding method preserves the entire SVG structure generated by dom-to-svg and adds x/y positioning attributes to place it in the larger SVG. This approach:

- Preserves the original SVG structure, viewBox, and namespace context
- Is simpler and more reliable across different types of content
- Results in nested SVG elements which may be less ideal for some applications

Implementation:
```javascript
// Get SVG from markdownToSvg()
const markdownResult = await markdownToSvg(nodeText, maxWidth);

// Calculate position
const svgX = node.x + (node.width - markdownResult.dimensions.width) / 2;
const svgY = node.y + (node.height - markdownResult.dimensions.height) / 2;

// Embed with utility function
const embeddedSvg = embedSvg(markdownResult.svg, svgX, svgY);
```

## Extraction Method (Alternative)

The extraction method extracts the inner content from the SVG and applies coordinate transformations to account for dom-to-svg's coordinate system. This approach:

- Avoids nested SVG elements in the final output
- Properly handles dom-to-svg's negative coordinate system through transformations
- Works well for flatter SVG structures but may require extra tuning for complex content

Implementation:
```javascript
// Get SVG from markdownToSvg()
const markdownResult = await markdownToSvg(nodeText, maxWidth);

// Calculate position
const svgX = node.x + (node.width - markdownResult.dimensions.width) / 2;
const svgY = node.y + (node.height - markdownResult.dimensions.height) / 2;

// Extract content with utility function
const extractedContent = extractSvgContent(markdownResult.svg, svgX, svgY);
```

## How It Works

The utility functions that handle both methods are defined in `src/utils/markdown-to-svg.js`:

### embedSvg Function

```javascript
/**
 * Embeds an SVG string into a larger SVG by adding positioning attributes
 * @param {string} svgString - The SVG string to embed
 * @param {number} x - The target X position
 * @param {number} y - The target Y position
 * @returns {string} - The modified SVG with positioning attributes
 */
export function embedSvg(svgString, x, y) {
  // Simply add x/y positioning to the root SVG element
  return svgString.replace(/<svg/, `<svg x="${x}" y="${y}"`);
}
```

### extractSvgContent Function

```javascript
/**
 * Extracts SVG inner content from an SVG string and prepares it for embedding in a larger SVG
 * @param {string} svgString - The SVG string to extract content from
 * @param {number} targetX - The target X position for the content
 * @param {number} targetY - The target Y position for the content
 * @returns {string} - SVG group element containing the extracted content with appropriate transforms
 */
export function extractSvgContent(svgString, targetX, targetY) {
  // Parse the SVG
  const parser = new DOMParser();
  const svgDoc = parser.parseFromString(svgString, 'image/svg+xml');
  const svgElement = svgDoc.documentElement;
  
  // Get inner content (all child nodes)
  let innerContent = '';
  for (const child of svgElement.childNodes) {
    if (child.nodeType === 1) { // Element nodes only
      const serializer = new XMLSerializer();
      innerContent += serializer.serializeToString(child);
    }
  }
  
  // Extract original SVG dimensions and viewBox
  const width = parseFloat(svgElement.getAttribute('width') || 0);
  const height = parseFloat(svgElement.getAttribute('height') || 0);
  
  // Extract viewBox to understand the coordinate system
  const viewBox = svgElement.getAttribute('viewBox');
  let minX = 0, minY = 0, vbWidth = width, vbHeight = height;
  
  if (viewBox) {
    const viewBoxValues = viewBox.split(' ').map(parseFloat);
    if (viewBoxValues.length === 4) {
      [minX, minY, vbWidth, vbHeight] = viewBoxValues;
    }
  }
  
  // Create group with appropriate transforms to compensate for coordinate system
  return `
    <!-- Extracted SVG content with coordinate transformations -->
    <g transform="translate(${targetX - minX}, ${targetY - minY})">
      <!-- Apply original SVG's viewBox scale if needed -->
      <g transform="scale(${width / vbWidth}, ${height / vbHeight})">
        ${innerContent}
      </g>
    </g>
  `;
}
```

## Technical Details

### dom-to-svg Coordinate System

The dom-to-svg library generates SVGs with a coordinate system that typically uses large negative values (around -9998) for positioning elements. This is transformed through the viewBox to map to the visible screen coordinates.

When extracting content from these SVGs, we need to:

1. Apply a translation to move from the negative coordinates to the target position
2. Apply a scale transformation to maintain the aspect ratio and sizing

### Testing

The test page at `/test_svg_extraction.html` allows you to compare both methods with different Markdown inputs. This is useful for debugging and understanding the rendering differences between the approaches.

## Recommended Approach

The extraction method (default) is now recommended for most cases because it:

1. Produces cleaner SVG structure without nesting
2. Creates more standard SVG output
3. May perform better in some renderers due to avoiding excessive nesting

The embedding method remains an alternative option when:

1. You encounter rendering issues with complex Markdown content
2. You need to preserve the exact structure of the original SVG
3. You're troubleshooting specific SVG compatibility problems

Both methods are fully supported and can be switched via the configuration option.